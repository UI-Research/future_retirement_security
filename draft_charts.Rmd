---
output:
  html_document:
    number_sections: FALSE
    self_contained: TRUE
    code_folding: hide
    toc: TRUE
    toc_float: TRUE
    css: www/web_report.css
    editor_options:
      chunk_output_type: console
self_contained: no      
editor_options:
  chunk_output_type: console
---

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato" />

![](www/images/urban-institute-logo.png)

```{r rmarkdown-setup, echo = FALSE}
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

knitr::opts_chunk$set(fig.width = 6.5, fig.height = 5, fig.path = "figures/", dev = c("png", "cairo_pdf"))
```

```{r setup}
options(scipen = 999)

library(tidyverse)
library(urbnthemes)
library(grid)
library(gridExtra)
library(extrafont)

source("urban_style.R")

set_urbn_defaults(style = "print")
```

### N Charts About Future Retirement Security plots
### Aaron R. Williams
### `r format(Sys.time(), "%B %d, %Y %H:%M %p")`

```{r}
cohorts <- c("1936-1945", "1946-1955", "1956-1965", "1966-1975", "1976-1985")

#' rename_cohort
#'
#' @param x a vector with cohorts
#'
#' @return a vector of renamed cohorts
rename_cohort <- function(x, two_lines = TRUE) {
  if (two_lines == TRUE) {
    cohort <- recode(x,
      `1936-1945` = "Pre-boomers\n(1936–1945)", 
      `1946-1955` = "Early boomers\n(1946–1955)", 
      `1956-1965` = "Late boomers\n(1956–1965)", 
      `1966-1975` = "Gen Xers\n(1966–1975)", 
      `1976-1985` = "Xennials\n(1976-1985)")  
    
    factor(cohort, levels = c("Pre-boomers\n(1936–1945)", 
                              "Early boomers\n(1946–1955)", 
                              "Late boomers\n(1956–1965)", 
                              "Gen Xers\n(1966–1975)", 
                              "Xennials\n(1976-1985)"))
  } else {
    cohort <- recode(x,
      `1936-1945` = "Pre-boomers (1936–1945)", 
      `1946-1955` = "Early boomers (1946–1955)", 
      `1956-1965` = "Late boomers (1956–1965)", 
      `1966-1975` = "Gen Xers (1966–1975)", 
      `1976-1985` = "Xennials (1976-1985)") 
      
    factor(cohort, levels = c("Pre-boomers (1936–1945)", 
                              "Early boomers (1946–1955)", 
                              "Late boomers (1956–1965)", 
                              "Gen Xers (1966–1975)", 
                              "Xennials (1976-1985)"))
  }
}

#' to_ordinal
#'
#' @param x translate numeric integers into ordinal numbers in a character vector 
#'
#' @return
#' @export
#'
#' @examples to_ordinal(1:30)
to_ordinal <- function(x, capitalize = FALSE, as_factor = FALSE) {
  # case_when(x %in% 11:13 ~ paste0(x, "th"),
  #           x %% 10 == 0 ~ paste0(x, "th"),
  #           x %% 10 == 1 ~ paste0(x, "st"),
  #           x %% 10 == 2 ~ paste0(x, "nd"),
  #           x %% 10 == 3 ~ paste0(x, "rd"),
  #           x %% 10 %in% 4:9 ~ paste0(x, "th"),
  #           TRUE ~ "ERROR")

  word <- case_when(x == 0 ~ "Zeroth",
                    x == 1 ~ "Bottom",
                    x == 2 ~ "Second",
                    x == 3 ~ "Third",
                    x == 4 ~ "Fourth",
                    x == 5 ~ "Top")  
  
  if (capitalize == TRUE) {
    tools::toTitleCase(word)
  } else {
    word
  }
}
```

## Theme 1: Retirement Incomes are Increasing

```{r theme1}
chart2 <- read_csv("data/figure2.csv") %>%
  filter(doby %in% cohorts) %>%
  mutate(doby = rename_cohort(doby)) %>%  
  ggplot(aes(doby, ncharts_aftertax_income_P50)) +
  geom_col() +
  geom_text(mapping = aes(label = scales::dollar(signif(ncharts_aftertax_income_P50, 3), largest_with_cents = 0)), 
            vjust = -1) +    
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis()

# create the output plot
plotr(titler("A typical Xennial retiree will receive about 30 percent more net income than a typical\nretiree born 40 years earlier"),
      subtitler("Median annual per capita after-tax family income at age 70 (constant 2018 dollars)"),
      chart2,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(2.8, 1.5, 30, 1, 1))
```

## Theme 2: Women's Lifetime Earnings are Increasing

```{r theme2}
chart4 <- read_csv("data/figure4.csv") %>%
  mutate(male = recode(male, 
                       `1.Male` = "Male",
                       `2.Female` = "Female")) %>%
  filter(doby %in% cohorts) %>%
  filter(!is.na(male)) %>%
  mutate(doby = rename_cohort(doby)) %>%  
  ggplot(aes(doby, lifetime_earn_P50, fill = male)) +
  geom_col(position = "dodge") +
  geom_text(mapping = aes(label = scales::dollar(round(lifetime_earn_P50, -2), largest_with_cents = 0)), 
            position = position_dodge(width = 1), vjust = -1) +    
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.15))) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis() 

# create the output plot
plotr(titler("Over her lifetime, a typical Xennial woman will earn more than twice as much as her\npre-boomer counterpart"),
      subtitler("Median earnings from ages 25 to 69 (constant 2018 dollars)"),
      chart4,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(2.6, 2, 30, 1, 1))
```

##  Theme 3: The share of retirees who will likely experience a decline in living standards will grow over time

* Numerator: age 70, price-adjusted, per-capita annuitized income
* Denominator: mean price-adjusted, per-capita earnings from ages 50 to 59

```{r theme3}
chart1 <- read_csv("data/figure1.csv") %>%
  filter(ncharts_reprate %in% c("0-50%", "50-75%")) %>%
  filter(doby %in% cohorts) %>%
  mutate(doby = rename_cohort(doby)) %>%
  group_by(doby) %>%
  summarize(rep_rate_threshold = sum(count_PctSum_10_count)) %>%
  ggplot(aes(doby, rep_rate_threshold)) +
  geom_col() +
  geom_text(mapping = aes(label = scales::percent_format(accuracy = 1)(rep_rate_threshold / 100)), vjust = -1) +    
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)),
                     limits = c(0, 50)) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis()   

# create the output plot
plotr(titler("Nearly one-third of Xennials will see their living standards fall when they retire"),
      subtitler("Share of adults unable to replace 75 percent of preretirement earnings at age 70"),
      chart1,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(2, 2, 30, 1, 1))
```

## Theme 4: The share of retirees who will likely experience a decline in living standards will grow slowly over time

```{r, theme4}

scheduled <- read_csv("data/figure1.csv") %>%
  mutate(law = "Current Social Security benefits continue")

payable <- read_csv("data/figure9.csv") %>%
  mutate(law = "Benefits cut 25%") %>%
  rename(ncharts_reprate = ncharts_reprate_payable)

chart9 <- bind_rows(scheduled, payable) %>%
  filter(ncharts_reprate %in% c("0-50%", "50-75%")) %>%
  filter(doby %in% cohorts) %>%
  group_by(doby, law) %>%
  summarize(rep_rate_threshold = sum(count_PctSum_10_count)) %>%
  ungroup() %>%
  mutate(law = factor(law, levels = c("Current Social Security benefits continue", "Benefits cut 25%"))) %>%
  mutate(doby = rename_cohort(doby)) %>%  
  ggplot(aes(doby, rep_rate_threshold, fill = law)) +
  geom_col(position = "dodge") +
  geom_text(mapping = aes(label = scales::percent_format(accuracy = 1)(rep_rate_threshold / 100)), 
            vjust = -1,
            position = position_dodge(width = 0.8)) +    
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis()

# create the output plot
plotr(titler("Retirement incomes may fall short for about 4 in 10 Xennials if policymakers\nignore Social Security’s financing gap"),
      subtitler("Share of adults unable to replace 75 percent of their preretirement earnings at age 70 "),
      chart9,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(3, 1.5, 30, 1, 1))
```

## Theme 5: Social Security Is a Pillar of Retirement Security

* Quintiles are based on per-capita, price-adjusted, shared annuitized income with federal taxes, state taxes, payroll taxes and the Medicare surtax at age 70.
* Values are the mean of the different sources of income in each quintile. 

Financial income = per-capita interest + per-capita dividends + per-capita rental income + per-capita IRA withdrawals

Other income = pcNotModel_Mean

```{r theme5}
incomes <- c("Other income", "Financial income", "DB pension income", "Earnings", "Social Security")
quintile <- c("Bottom quintile", "Second quintile", "Third quintile", "Fourth quintile", "Top quintile")

chart7alt <- read_csv("data/figure7.csv") %>%
  mutate(nchartQuin = paste(to_ordinal(nchartQuin), "quintile")) %>%
  mutate(nchartQuin = factor(nchartQuin, levels = quintile)) %>%
  mutate(ss_share = PCssb_Mean / ncharts_aftertax_income_Mean) %>%
  filter(doby %in% cohorts) %>%
  select(nchartQuin, doby, ss_share) %>%
  ggplot(aes(doby, ss_share, fill = nchartQuin)) +
  geom_col(position = "dodge") +
  geom_text(aes(label = scales::percent_format(accuracy = 1)(ss_share)),
            position = position_dodge(width = 0.7),
            vjust = -0.8,
            hjust = 0.35) +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1)), 
                     labels = scales::percent) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis()

# create the output plot
plotr(titler("Social Security accounts for about 90 percent of income for low-income retirees"),
      subtitler("Share of per capita family income at age 70 from Social Security by income quintile"),
      chart7alt,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(1.8, 1, 30, 1, 1))
```

## Theme 6:

```{r, theme6}
chart12 <- read_csv("data/figure12.csv") %>%
  filter(doby %in% cohorts) %>%
  rename(`Current Social Security benefits continue` = ncharts_pov_Mean, 
         `Benefits cut 25%` = ncharts_pov_payable_Mean) %>%
  mutate(doby = rename_cohort(doby)) %>% 
  gather(key = "law", value = "poverty", -doby, -Obs) %>%
  mutate(law = factor(law, levels = c("Current Social Security benefits continue", "Benefits cut 25%"))) %>%
  ggplot(aes(doby, poverty, fill = law)) +
  geom_col(position = "dodge") +
  geom_text(mapping = aes(label = scales::percent_format(accuracy = 0.1)(poverty)), 
            vjust = -1,
            position = position_dodge(width = 0.8)) +    
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis()  

# create the output plot
plotr(titler("A 25 percent Social Security benefit cut could leave about 1 in 12 Gen X and Xennial\nretirees in poverty"),
      subtitler("Percentage of adults with incomes below the federal poverty level at age 70 "),
      chart12,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(2.8, 1.5, 30, 1, 1))
```

## Theme 7: Racial and ethnic disparities in retirement income will persist 

```{r theme7}
chart6 <- read_csv("data/figure6.csv") %>%
  filter(doby %in% cohorts) %>%
  filter(!is.na(raceeth)) %>%
  filter(raceeth != "4.Other") %>%
  mutate(raceeth = recode(raceeth, 
                          `1.White, Non-Hisp` = "White, non-Hispanic",
                          `2.Black, Non-Hisp` = "Black, non-Hispanic",
                          `3.Hispanic` = "Hispanic"
                          )) %>%  
  mutate(doby = rename_cohort(doby)) %>%  
  ggplot(aes(doby, ncharts_aftertax_income_P50, fill = raceeth)) +
  geom_col(position = "dodge") +
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.15)), 
                     labels = scales::dollar) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks()

# create the output plot
plotr(titler("Although retirement incomes are projected to rise for people of color, they\nwill continue to lag far behind incomes for non-Hispanic white people"),
      subtitler("Median annual per capita after-tax family income at age 70 (thousands of constant 2018 dollars)"),
      chart6,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(3, 1.5, 30, 1, 1))
```

## Theme 8: The Gender Gap in Social Secuirty Benefits is Narrowing

```{r, theme8}
chart3b <- read_csv("data/figure3b.csv") %>%
  mutate(male = recode(male, 
                       `1.Male` = "Male",
                       `2.Female` = "Female")) %>%  
  filter(doby %in% cohorts) %>%
  mutate(doby = rename_cohort(doby)) %>%  
  ggplot(aes(doby, Ownssb_P50, fill = male)) +
  geom_col(position = "dodge") +
  geom_text(mapping = aes(label = scales::dollar(round(Ownssb_P50, -2), largest_with_cents = 0)), 
            position = position_dodge(width = 0.75), vjust = -1) +    
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.15))) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis() 

# create the output plot
plotr(titler("For Xennials, women’s median Social Security benefits at age 70 will rise to 85 percent of\nthe median for men"),
      subtitler("Median annual Social Security income at age 70 (constant 2018 dollars)"),
      chart3b,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(2.6, 2, 30, 1, 1))
```

## Theme 9

```{r, theme9}

chart13 <- read_csv("data/figure13.csv") %>%
  filter(doby %in% cohorts) %>%
  mutate(avg_annual_tax_rate = (-1 * ncharts_tax_Mean) / ncharts_income_Mean) %>%
  mutate(doby = rename_cohort(doby)) %>%    
  filter(is.na(nchartQuin)) %>%
  ggplot(aes(doby, avg_annual_tax_rate)) +
  geom_col() +
  geom_text(mapping = aes(label = scales::percent_format(accuracy = 1)(avg_annual_tax_rate)), 
            vjust = -1,
            position = position_dodge(width = 0.8)) +    
  scale_y_continuous(expand = expand_scale(mult = c(0, 0.1))) +
  labs(x = "Birth Cohort",
       y = NULL) +
  remove_ticks() +
  remove_axis()  

plotr(titler("Average tax rates for retirees will grow over time"),
      subtitler("Average annual tax rate at age 70"),
      chart13,
      caption,
      sourcer("DYNASIM4, ID963"),
      heights = c(2.6, 1, 30, 1, 1))
```
